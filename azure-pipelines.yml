trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  AZURE_SUBSCRIPTION: 'stevens-capstone-conn'

  DEV_RESOURCE_GROUP:  steven-rg-capstone-dev
  QA_RESOURCE_GROUP:   steven-rg-capstone-qa
  PROD_RESOURCE_GROUP: steven-rg-capstone-prod

  DEV_WEBAPP_NAME: stevens-webapp-frontend-dev
  QA_WEBAPP_NAME: stevens-webapp-frontend-qa
  PROD_WEBAPP_NAME: stevens-webapp-frontend-prod

  DEV_API_URL:  https://apim-capstone-dev-a1b2c.azure-api.net
  QA_API_URL:   https://apim-capstone-qa-a1b2c.azure-api.net
  PROD_API_URL: https://apim-capstone-prod-a1b2c.azure-api.net

stages:
# ---------------------------------------------------
# 1. DEV DEPLOYMENT
# ---------------------------------------------------
- stage: Dev
  displayName: "Deploy to Development"
  jobs:
    - job: TerraformDev
      displayName: "Terraform Apply (Dev)"
      pool:
        vmImage: 'ubuntu-latest'

      steps:
        - checkout: self

        - script: |
            echo "Installing Terraform..."
            sudo apt-get update -y
            sudo apt-get install -y wget unzip
            wget https://releases.hashicorp.com/terraform/1.9.8/terraform_1.9.8_linux_amd64.zip
            unzip terraform_1.9.8_linux_amd64.zip
            sudo mv terraform /usr/local/bin/
            terraform -version
          displayName: "Install Terraform"

        - task: AzureCLI@2
          displayName: "Get tenant ID for Terraform variables"
          inputs:
            azureSubscription: $(AZURE_SUBSCRIPTION)
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              TENANT_ID=$(az account show --query tenantId -o tsv)
              echo "Tenant from az: $TENANT_ID"
              echo "##vso[task.setvariable variable=TENANT_ID]$TENANT_ID"

        - task: TerraformTaskV4@4
          displayName: "Terraform Init (Dev)"
          env:
            TF_VAR_tenant_id: $(TENANT_ID)
          inputs:
            provider: azurerm
            command: init
            backendServiceArm: stevens-capstone-conn
            backendAzureRmResourceGroupName: steven-tfstate-rg
            backendAzureRmStorageAccountName: steventfstateaccount
            backendAzureRmContainerName: tfstate
            backendAzureRmKey: dev.terraform.tfstate
            workingDirectory: environments/dev

        - task: TerraformTaskV4@4
          displayName: "Terraform Plan (Dev)"
          env:
            TF_VAR_tenant_id: $(TENANT_ID)
          inputs:
            provider: azurerm
            command: plan
            environmentServiceNameAzureRM: stevens-capstone-conn
            workingDirectory: environments/dev
            commandOptions: "-var-file=dev.tfvars -out=tfplan"

        - task: AzureCLI@2
          displayName: Terraform Apply (DEV)
          env:
            TF_VAR_tenant_id: $(TENANT_ID)
          inputs:
            azureSubscription: $(AZURE_SUBSCRIPTION)
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              set -euo pipefail
              cd environments/dev

              terraform apply -auto-approve tfplan

              # Initialize database schema
              echo "Initializing PostgreSQL database schema..."
              az postgres flexible-server execute \
                --name psql-capstone-dev-a1b2c \
                --admin-user stevushka \
                --admin-password "4285Vion" \
                --database-name appdb \
                --file-path ../../modules/postgres/init.sql

              az webapp config appsettings set \
                --name $(DEV_WEBAPP_NAME) \
                --resource-group $(DEV_RESOURCE_GROUP) \
                --settings REACT_APP_API_URL=$(DEV_API_URL)

# ---------------------------------------------------
# 2. QA DEPLOYMENT (Manual Approval Before Running)
# ---------------------------------------------------
- stage: QA
  displayName: "Deploy to Testing"
  dependsOn: Dev
  condition: succeeded()

  jobs:
    - deployment: TerraformQA
      displayName: "Terraform Apply (QA)"
      environment: "qa-env"
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              - script: |
                  echo "Installing Terraform..."
                  sudo apt-get update -y
                  sudo apt-get install -y wget unzip
                  wget https://releases.hashicorp.com/terraform/1.9.8/terraform_1.9.8_linux_amd64.zip
                  unzip terraform_1.9.8_linux_amd64.zip
                  sudo mv terraform /usr/local/bin/
                  terraform -version
                displayName: "Install Terraform"

              - task: AzureCLI@2
                displayName: "Get tenant ID for Terraform variables"
                inputs:
                  azureSubscription: $(AZURE_SUBSCRIPTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    TENANT_ID=$(az account show --query tenantId -o tsv)
                    echo "Tenant from az: $TENANT_ID"
                    echo "##vso[task.setvariable variable=TENANT_ID]$TENANT_ID"

              - task: TerraformTaskV4@4
                displayName: "Terraform Init (QA)"
                env:
                  TF_VAR_tenant_id: $(TENANT_ID)
                inputs:
                  provider: azurerm
                  command: init
                  backendServiceArm: stevens-capstone-conn
                  backendAzureRmResourceGroupName: steven-tfstate-rg
                  backendAzureRmStorageAccountName: steventfstateaccount
                  backendAzureRmContainerName: tfstate
                  backendAzureRmKey: qa.terraform.tfstate
                  workingDirectory: environments/qa

              - task: TerraformTaskV4@4
                displayName: "Terraform Plan (QA)"
                env:
                  TF_VAR_tenant_id: $(TENANT_ID)
                inputs:
                  provider: azurerm
                  command: plan
                  environmentServiceNameAzureRM: stevens-capstone-conn
                  workingDirectory: environments/qa
                  commandOptions: "-var-file=qa.tfvars -out=tfplan"

              - task: AzureCLI@2
                displayName: Terraform Apply (QA)
                env:
                  TF_VAR_tenant_id: $(TENANT_ID)
                inputs:
                  azureSubscription: $(AZURE_SUBSCRIPTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    set -euo pipefail
                    cd environments/qa

                    terraform apply -auto-approve tfplan

                    # Initialize database schema
                    echo "Initializing PostgreSQL database schema..."
                    az postgres flexible-server execute \
                      --name psql-capstone-qa-a1b2c \
                      --admin-user stevushka \
                      --admin-password "4285Vion" \
                      --database-name appdb \
                      --file-path ../../modules/postgres/init.sql

                    az webapp config appsettings set \
                      --name $(QA_WEBAPP_NAME) \
                      --resource-group $(QA_RESOURCE_GROUP) \
                      --settings REACT_APP_API_URL=$(QA_API_URL)

# ---------------------------------------------------
# 2. PROD DEPLOYMENT (Manual Approval Before Running)
# ---------------------------------------------------
- stage: Prod
  displayName: "Deploy to Production"
  dependsOn: QA
  condition: succeeded()

  jobs:
    - deployment: TerraformProd
      displayName: "Terraform Apply (Prod)"
      environment: "production-env"
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              - script: |
                  echo "Installing Terraform..."
                  sudo apt-get update -y
                  sudo apt-get install -y wget unzip
                  wget https://releases.hashicorp.com/terraform/1.9.8/terraform_1.9.8_linux_amd64.zip
                  unzip terraform_1.9.8_linux_amd64.zip
                  sudo mv terraform /usr/local/bin/
                  terraform -version
                displayName: "Install Terraform"

              - task: AzureCLI@2
                displayName: "Get tenant ID for Terraform variables"
                inputs:
                  azureSubscription: $(AZURE_SUBSCRIPTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    TENANT_ID=$(az account show --query tenantId -o tsv)
                    echo "Tenant from az: $TENANT_ID"
                    echo "##vso[task.setvariable variable=TENANT_ID]$TENANT_ID"

              - task: TerraformTaskV4@4
                displayName: "Terraform Init (Prod)"
                env:
                  TF_VAR_tenant_id: $(TENANT_ID)
                inputs:
                  provider: azurerm
                  command: init
                  backendServiceArm: stevens-capstone-conn
                  backendAzureRmResourceGroupName: steven-tfstate-rg
                  backendAzureRmStorageAccountName: steventfstateaccount
                  backendAzureRmContainerName: tfstate
                  backendAzureRmKey: prod.terraform.tfstate
                  workingDirectory: environments/prod

              - task: TerraformTaskV4@4
                displayName: "Terraform Plan (Prod)"
                env:
                  TF_VAR_tenant_id: $(TENANT_ID)
                inputs:
                  provider: azurerm
                  command: plan
                  environmentServiceNameAzureRM: stevens-capstone-conn
                  workingDirectory: environments/prod
                  commandOptions: "-var-file=prod.tfvars -out=tfplan"

              - task: AzureCLI@2
                displayName: Terraform Apply (PROD)
                env:
                  TF_VAR_tenant_id: $(TENANT_ID)
                inputs:
                  azureSubscription: $(AZURE_SUBSCRIPTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    set -euo pipefail
                    cd environments/prod

                    terraform apply -auto-approve tfplan

                    # Initialize database schema
                    echo "Initializing PostgreSQL database schema..."
                    az postgres flexible-server execute \
                      --name psql-capstone-prod-a1b2c \
                      --admin-user stevushka \
                      --admin-password "4285Vion" \
                      --database-name appdb \
                      --file-path ../../modules/postgres/init.sql

                    az webapp config appsettings set \
                      --name $(PROD_WEBAPP_NAME) \
                      --resource-group $(PROD_RESOURCE_GROUP) \
                      --settings REACT_APP_API_URL=$(PROD_API_URL)