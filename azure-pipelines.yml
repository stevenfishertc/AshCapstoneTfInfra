trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  AZURE_SUBSCRIPTION: 'stevens-capstone-conn'   # Service connection name

stages:
# ---------------------------------------------------
# 1. DEV DEPLOYMENT
# ---------------------------------------------------
- stage: Dev
  displayName: "Deploy to Development"
  jobs:
    - job: TerraformDev
      displayName: "Terraform Apply (Dev)"
      pool:
        vmImage: 'ubuntu-latest'

      steps:
        - checkout: self

        - script: |
            echo "Installing Terraform..."
            sudo apt-get update -y
            sudo apt-get install -y wget unzip
            wget https://releases.hashicorp.com/terraform/1.9.8/terraform_1.9.8_linux_amd64.zip
            unzip terraform_1.9.8_linux_amd64.zip
            sudo mv terraform /usr/local/bin/
            terraform -version
          displayName: "Install Terraform"

        - task: AzureCLI@2
          displayName: "Terraform Init (Dev)"
          inputs:
            azureSubscription: $(AZURE_SUBSCRIPTION)
            scriptType: bash
            scriptLocation: inlineScript
            workingDirectory: environments/dev
            addSpnToEnvironment: true
            inlineScript: |
              export ARM_CLIENT_ID=$servicePrincipalId
              export ARM_CLIENT_SECRET=$servicePrincipalKey
              export ARM_TENANT_ID=$tenantId
              export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

              terraform init

        - task: AzureCLI@2
          displayName: "Terraform Plan (Dev)"
          inputs:
            azureSubscription: $(AZURE_SUBSCRIPTION)
            scriptType: bash
            scriptLocation: inlineScript
            workingDirectory: environments/dev
            addSpnToEnvironment: true
            inlineScript: |
              export ARM_CLIENT_ID=$servicePrincipalId
              export ARM_CLIENT_SECRET=$servicePrincipalKey
              export ARM_TENANT_ID=$tenantId
              export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

              terraform plan -var-file="terraform.tfvars" -out=tfplan

        - task: AzureCLI@2
          displayName: "Terraform Apply (Dev)"
          inputs:
            azureSubscription: $(AZURE_SUBSCRIPTION)
            scriptType: bash
            scriptLocation: inlineScript
            workingDirectory: environments/dev
            addSpnToEnvironment: true
            inlineScript: |
              export ARM_CLIENT_ID=$servicePrincipalId
              export ARM_CLIENT_SECRET=$servicePrincipalKey
              export ARM_TENANT_ID=$tenantId
              export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

              terraform apply -auto-approve tfplan

# ---------------------------------------------------
# 2. QA DEPLOYMENT (Manual Approval Before Running)
# ---------------------------------------------------
- stage: QA
  displayName: "Deploy to Testing"
  dependsOn: Dev
  condition: succeeded()

  jobs:
    - deployment: TerraformQA          # <-- deployment job required
      displayName: "Terraform Apply (QA)"
      environment: "qa-env"
      
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              - script: |
                  echo "Installing Terraform..."
                  sudo apt-get update -y
                  sudo apt-get install -y wget unzip
                  wget https://releases.hashicorp.com/terraform/1.9.8/terraform_1.9.8_linux_amd64.zip
                  unzip terraform_1.9.8_linux_amd64.zip
                  sudo mv terraform /usr/local/bin/
                  terraform -version
                displayName: "Install Terraform"

              - task: AzureCLI@2
                displayName: "Terraform Init (QA)"
                inputs:
                  azureSubscription: $(AZURE_SUBSCRIPTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: environments/qa
                  addSpnToEnvironment: true
                  inlineScript: |
                    export ARM_CLIENT_ID=$servicePrincipalId
                    export ARM_CLIENT_SECRET=$servicePrincipalKey
                    export ARM_TENANT_ID=$tenantId
                    export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

                    terraform init

              - task: AzureCLI@2
                displayName: "Terraform Plan (QA)"
                inputs:
                  azureSubscription: $(AZURE_SUBSCRIPTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: environments/qa
                  addSpnToEnvironment: true
                  inlineScript: |
                    export ARM_CLIENT_ID=$servicePrincipalId
                    export ARM_CLIENT_SECRET=$servicePrincipalKey
                    export ARM_TENANT_ID=$tenantId
                    export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

                    terraform plan -var-file="terraform.tfvars" -out=tfplan

              - task: AzureCLI@2
                displayName: "Terraform Apply (QA)"
                inputs:
                  azureSubscription: $(AZURE_SUBSCRIPTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: environments/qa
                  addSpnToEnvironment: true
                  inlineScript: |
                    export ARM_CLIENT_ID=$servicePrincipalId
                    export ARM_CLIENT_SECRET=$servicePrincipalKey
                    export ARM_TENANT_ID=$tenantId
                    export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                    
                    terraform apply -auto-approve tfplan

# ---------------------------------------------------
# 2. PROD DEPLOYMENT (Manual Approval Before Running)
# ---------------------------------------------------
- stage: Prod
  displayName: "Deploy to Production"
  dependsOn: QA
  condition: succeeded()

  jobs:
    - deployment: TerraformProd          # <-- deployment job required
      displayName: "Terraform Apply (Prod)"
      environment: "production-env"
      
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              - script: |
                  echo "Installing Terraform..."
                  sudo apt-get update -y
                  sudo apt-get install -y wget unzip
                  wget https://releases.hashicorp.com/terraform/1.9.8/terraform_1.9.8_linux_amd64.zip
                  unzip terraform_1.9.8_linux_amd64.zip
                  sudo mv terraform /usr/local/bin/
                  terraform -version
                displayName: "Install Terraform"

              - task: AzureCLI@2
                displayName: "Terraform Init (Prod)"
                inputs:
                  azureSubscription: $(AZURE_SUBSCRIPTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: environments/prod
                  addSpnToEnvironment: true
                  inlineScript: |
                    export ARM_CLIENT_ID=$servicePrincipalId
                    export ARM_CLIENT_SECRET=$servicePrincipalKey
                    export ARM_TENANT_ID=$tenantId
                    export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

                    terraform init

              - task: AzureCLI@2
                displayName: "Terraform Plan (Prod)"
                inputs:
                  azureSubscription: $(AZURE_SUBSCRIPTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: environments/prod
                  addSpnToEnvironment: true
                  inlineScript: |
                    export ARM_CLIENT_ID=$servicePrincipalId
                    export ARM_CLIENT_SECRET=$servicePrincipalKey
                    export ARM_TENANT_ID=$tenantId
                    export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

                    terraform plan -var-file="terraform.tfvars" -out=tfplan

              - task: AzureCLI@2
                displayName: "Terraform Apply (Prod)"
                inputs:
                  azureSubscription: $(AZURE_SUBSCRIPTION)
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: environments/prod
                  addSpnToEnvironment: true
                  inlineScript: |
                    export ARM_CLIENT_ID=$servicePrincipalId
                    export ARM_CLIENT_SECRET=$servicePrincipalKey
                    export ARM_TENANT_ID=$tenantId
                    export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                    
                    terraform apply -auto-approve tfplan





